<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medieval European Quest</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            font-family: 'MedievalSharp', cursive;
            background: linear-gradient(135deg, #f4e4bc 0%, #e6d5b8 100%);
            color: #2c1810;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .map-container {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            height: 600px;
            position: relative;
        }
        .map-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        .controls button {
            width: 40px;
            height: 40px;
            margin: 2px;
            font-size: 1.2em;
            background-color: #8b4513;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .controls button:hover {
            background-color: #654321;
        }
        .game-info {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        .riddle-section {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            border: 3px solid #8b4513;
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            max-width: 500px;
            width: 90%;
        }
        .riddle-section h3 {
            color: #87138b;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        .riddle-section p {
            font-size: 1.2em;
            margin-bottom: 20px;
            line-height: 1.4;
        }
        .riddle-section input[type="text"] {
            width: 80%;
            padding: 12px;
            font-size: 1.1em;
            margin-bottom: 15px;
        }
        .riddle-section button {
            font-size: 1.1em;
            padding: 12px 25px;
        }
        .event-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 5px;
            border: 2px solid #8b4513;
        }
        .flash-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid transparent;
        }
        .success { 
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error { 
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .info { 
            background-color: #cce5ff;
            border-color: #b8daff;
            color: #004085;
        }
        button {
            background-color: #8b4513;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'MedievalSharp', cursive;
            margin: 5px;
            transition: background-color 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        button:hover {
            background-color: #654321;
        }
        input[type="text"] {
            padding: 8px;
            border: 2px solid #8b4513;
            border-radius: 5px;
            font-family: 'MedievalSharp', cursive;
            width: 200px;
        }
        .completion-message {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            background: rgba(175, 12, 121, 0.1);
            border-radius: 10px;
            border: 2px solid #8b4513;
        }
        .completion-message i {
            font-size: 2em;
            color: #8b4513;
            margin-bottom: 10px;
        }
        .progress-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 5px;
            border: 2px solid #8b4513;
        }
        .stamina-bar {
            width: 100%;
            height: 20px;
            background: #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .stamina-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s ease;
        }
        .achievements-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 5px;
            border: 2px solid #8b4513;
        }
        .achievement {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin: 5px 0;
            background: rgba(139, 69, 19, 0.1);
            border-radius: 5px;
            transition: transform 0.3s ease;
        }
        .achievement.unlocked {
            background: rgba(76, 175, 80, 0.1);
        }
        .achievement-icon {
            font-size: 1.5em;
        }
        .achievement-info {
            flex-grow: 1;
        }
        .achievement-name {
            font-weight: bold;
        }
        .achievement-description {
            font-size: 0.9em;
            color: #666;
        }
        .achievement-points {
            font-weight: bold;
            color: #8b4513;
        }
        .score-section {
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 20px;
        }
        .total-score {
            font-size: 1.5em;
            font-weight: bold;
            color: #8b4513;
        }
        .progress-counter {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        .progress-counter i {
            font-size: 1.5em;
            color: #8b4513;
        }
        .progress-counter .horse-rider {
            display: inline-flex;
            align-items: center;
            background: rgba(139, 69, 19, 0.1);
            padding: 5px 15px;
            border-radius: 20px;
            border: 2px solid #8b4513;
        }
        .progress-counter .horse-rider i {
            margin-right: 8px;
        }
        .reset-button {
            text-decoration: none;
            display: inline-block;
        }
        .location-info {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 5px;
            border: 2px solid #8b4513;
        }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            border: 3px solid #8b4513;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        
        .modal-content h3 {
            color: #8b4513;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        
        .modal-content p {
            font-size: 1.3em;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        
        .modal-content input[type="text"] {
            width: 80%;
            padding: 15px;
            font-size: 1.2em;
            margin-bottom: 20px;
            border: 2px solid #8b4513;
            border-radius: 8px;
        }
        
        .modal-content button {
            font-size: 1.2em;
            padding: 12px 30px;
            background-color: #8b4513;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .modal-content button:hover {
            background-color: #654321;
        }
        
        .controls.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .followers-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 5px;
            border: 2px solid #8b4513;
        }
        
        .follower-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .follower {
            background: rgba(139, 69, 19, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            border: 2px solid #8b4513;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .follower i {
            color: #8b4513;
        }
        
        .follower.new {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chateau-reveal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .chateau-content {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 15px;
            border: 3px solid #8b4513;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 90%;
            text-align: center;
            position: relative;
        }

        .chateau-photos {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .chateau-photo {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid #8b4513;
            transition: transform 0.3s;
        }

        .chateau-photo:hover {
            transform: scale(1.05);
        }

        .chateau-message {
            font-size: 1.4em;
            margin-bottom: 20px;
            color: #8b4513;
            line-height: 1.6;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(139, 69, 19, 0.1);
            border-radius: 10px;
        }
        .cities-visited {
            font-size: 1.2em;
            color: #8b4513;
        }
        .cities-visited h2 {
            margin: 0;
        }
        .current-location h2 {
            margin: 0;
            color: #2c1810;
        }
        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #8b4513;
            padding: 5px;
        }
        .close-button:hover {
            color: #654321;
        }
        .game-stats {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 250px;
            border: 2px solid #8b4513;
        }

        .stats-box, .companions-box {
            margin-bottom: 20px;
        }

        .stats-box h3, .companions-box h3 {
            margin: 0 0 15px 0;
            font-size: 1.2em;
            color: #8b4513;
            border-bottom: 2px solid rgba(139, 69, 19, 0.2);
            padding-bottom: 5px;
        }

        .stats-box p {
            margin: 8px 0;
            font-size: 1em;
            color: #2c1810;
        }

        .companion {
            background: rgba(139, 69, 19, 0.1);
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 6px;
            font-size: 0.95em;
            border: 1px solid rgba(139, 69, 19, 0.2);
        }

        /* Reduce banner sizes */
        .achievement-banner {
            font-size: 0.9em;
            padding: 8px 12px;
            margin: 5px 0;
            max-width: 200px;
        }

        .event-banner {
            font-size: 0.9em;
            padding: 8px 12px;
            margin: 5px 0;
            max-width: 200px;
        }

        #achievements-list {
            max-height: 40vh;
            overflow-y: auto;
        }

        /* Add music control styles */
        .music-control {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            border: 2px solid #8b4513;
        }
        .music-control button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #8b4513;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .music-control button:hover {
            background: rgba(139, 69, 19, 0.1);
        }
        .music-control .volume-slider {
            width: 100px;
            margin: 0 10px;
        }
        .chateau-links {
            margin: 20px 0;
            text-align: center;
        }
        
        .chateau-links p {
            margin-bottom: 15px;
            font-size: 1.2em;
            color: #8b4513;
        }
        
        .chateau-links .btn {
            margin: 0 10px;
            padding: 10px 20px;
            background-color: #8b4513;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            display: inline-block;
            transition: background-color 0.3s;
        }
        
        .chateau-links .btn:hover {
            background-color: #654321;
        }
        
        .chateau-image {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <!-- Add audio elements -->
    <audio id="bgMusic" loop>
        <source src="{{ url_for('static', filename='music/background.mp3') }}" type="audio/mp3">
        Your browser does not support the audio element.
    </audio>
    <audio id="mysteryMusic" loop>
        <source src="{{ url_for('static', filename='music/mystery.mp3') }}" type="audio/mp3">
        Your browser does not support the audio element.
    </audio>

    <!-- Add music controls -->
    <div class="music-control">
        <span>🎵</span>
        <input type="range" class="volume-slider" id="volumeControl" min="0" max="100" value="50">
        <span id="volumeDisplay">50%</span>
    </div>

    <!-- Add Château reveal modal -->
    <div id="chateau-reveal" class="chateau-reveal">
        <div class="chateau-content">
            <h2>A Discovery!</h2>
            <p class="chateau-message">
                A new location has been revealed on the map...
            </p>
            <button onclick="document.getElementById('chateau-reveal').style.display='none'">Continue Your Quest</button>
        </div>
    </div>

    <!-- Add Château arrival modal -->
    <div id="chateau-arrival" class="chateau-reveal">
        <div class="chateau-content">
            <h2>The Château Awaits!</h2>
            <p class="chateau-message">
                VICTORY! The Château has been revealed! Your journey, sacrifices and commitment all through your life has led you to this one specific moment.
                Make your way to the château to suckle on its sweet summer fruit...
            </p>
            <img src="{{ url_for('static', filename='chateau_mist.jpg') }}" alt="Château in the mist" class="chateau-image">
            <button onclick="document.getElementById('chateau-arrival').style.display='none'">Continue Your Quest</button>
        </div>
    </div>

    <!-- Add modal overlay for riddle -->
    <div id="modalOverlay" class="modal-overlay"></div>
    <div id="riddleSection" class="riddle-section">
        <button class="close-button" onclick="closeRiddleModal()">×</button>
        <h3>Riddle of <span id="cityName"></span></h3>
        <p id="riddleText"></p>
        <input type="text" id="riddleAnswer" placeholder="Your answer...">
        <button onclick="submitRiddleAnswer()">Submit Answer</button>
    </div>

    <!-- Add event modal -->
    <div id="event-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="event-modal-title"></h3>
            <p id="event-modal-description"></p>
            <div id="event-modal-choices"></div>
        </div>
    </div>

    <!-- Add death modal -->
    <div id="death-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Game Over</h3>
            <p id="death-message"></p>
            <button onclick="window.location.href='/'">Return to Start</button>
        </div>
    </div>

    <div class="container">
        <div class="map-container">
            <h2>Journey Through Medieval Europe</h2>
            <iframe src="{{ url_for('map_view') }}" allowfullscreen></iframe>
            <div class="controls">
                <button onclick="move('w')">W</button>
                <button onclick="move('a')">A</button>
                <button onclick="move('s')">S</button>
                <button onclick="move('d')">D</button>
            </div>
        </div>
        
        <div class="game-info">
            <div class="progress-header">
                <div class="cities-visited">
                    <h2>Cities Visited: <span id="main-cities-count">{{ game_state.riddles_solved|length }}/{{ game_state.total_cities }}</span></h2>
                </div>
                <div class="current-location">
                    <h2>Current Location: <span id="main-current-location">{{ game_state.current_city if game_state.current_city else "Exploring" }}</span></h2>
                </div>
            </div>
            <p>{{ city.description }}</p>
            
            <div class="location-info">
                <p>Distance to nearest city: <span id="distance">Calculating...</span></p>
                <p>Status: <span id="status">Exploring...</span></p>
            </div>
            
            <div id="event-section" class="event-section" style="display: none;">
                <h3 id="event-title"></h3>
                <p id="event-description"></p>
                <div id="event-choices"></div>
            </div>
            
            <div class="followers-section">
                <h3>Your Traveling Companions</h3>
                <div class="follower-list" id="follower-list">
                    {% for follower in game_state.followers %}
                    <div class="follower">
                        <i class="fas fa-user"></i>
                        <span>{{ follower }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="flash-message {{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            {% if game_state.game_completed %}
            <div class="completion-message">
                <i class="fas fa-crown"></i>
                <h3>Congratulations, Noble Adventurer!</h3>
                <p>You have completed your journey through the cities of Europe. The mysterious Château de Goudourville has been revealed on your map.</p>
                <p>May your name be remembered in the annals of history!</p>
            </div>
            {% endif %}

            <div class="score-section">
                <h3>Score</h3>
                <div class="total-score">{{ game_state.score.total }}</div>
            </div>

            <div class="stamina-section">
                <h3>Stamina</h3>
                <div class="stamina-bar">
                    <div class="stamina-fill" id="stamina-fill"></div>
                </div>
            </div>

            <div class="achievements-section">
                <h3>Achievements</h3>
                {% for achievement in ACHIEVEMENTS.values() %}
                <div class="achievement {% if achievement.name in game_state.achievements %}unlocked{% endif %}">
                    <div class="achievement-icon">{{ achievement.icon }}</div>
                    <div class="achievement-info">
                        <div class="achievement-name">{{ achievement.name }}</div>
                        <div class="achievement-description">{{ achievement.description }}</div>
                    </div>
                    <div class="achievement-points">{{ achievement.points }}</div>
                </div>
                {% endfor %}
            </div>

            <div class="progress-section">
                <h3>Your Progress</h3>
                <p>Moves: <span id="moves">{{ game_state.moves }}</span></p>
                <div class="progress-counter">
                    <div class="horse-rider">
                        <i class="fas fa-horse-head"></i>
                        <span>Cities Visited: {{ game_state.riddles_solved|length }}/{{ CITIES|length }}</span>
                    </div>
                    <div class="character-info">
                        <span class="character-icon">{{ characters[game_state.character].icon }}</span>
                        <span>{{ characters[game_state.character].name }}</span>
                    </div>
                </div>
                <a href="{{ url_for('reset_game') }}" class="reset-button">
                    <button type="button">Reset Game</button>
                </a>
            </div>

            <div class="game-stats">
                <div class="stats-box">
                    <h3>Journey Progress</h3>
                    <p>Cities Visited: <span id="cities-visited">{{ game_state.riddles_solved|length }}/{{ game_state.total_cities }}</span></p>
                    <p>Current Location: <span id="current-location">{{ game_state.current_city if game_state.current_city else "Exploring" }}</span></p>
                    <p>Moves Made: <span id="moves-counter">{{ game_state.moves }}</span></p>
                    <p>Score: <span id="score-counter">{{ game_state.score.total }}</span></p>
                </div>

                <div class="companions-box">
                    <h3>Fellow Travelers</h3>
                    <div id="companions-list">
                        {% if game_state.companions %}
                            {% for companion in game_state.companions %}
                                <div class="companion">{{ companion }}</div>
                            {% endfor %}
                        {% else %}
                            <p>No companions yet</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add the death modal -->
    <div class="modal fade" id="deathModal" tabindex="-1" aria-labelledby="deathModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deathModalLabel">Game Over!</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="deathMessage"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="window.location.href='/reset'">Start New Game</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let canMove = true;
        let lastMoveTime = 0;
        const moveDelay = 100; // Minimum delay between moves in milliseconds
        
        // Handle keyboard controls globally
        document.addEventListener('keydown', function(e) {
            // Only block movement if we're in a modal or actively typing in an input/textarea
            const activeElement = document.activeElement;
            const isTyping = activeElement && (
                activeElement.tagName === 'INPUT' ||
                activeElement.tagName === 'TEXTAREA' ||
                activeElement.isContentEditable
            );
            
            if (!canMove || isTyping) return;
            
            const key = e.key.toLowerCase();
            if (['w', 'a', 's', 'd'].includes(key)) {
                e.preventDefault(); // Prevent page scrolling
                
                // Rate limit the movement
                const now = Date.now();
                if (now - lastMoveTime >= moveDelay) {
                    move(key);
                    lastMoveTime = now;
                }
            }
        });

        // Add focus handling to ensure map controls work even when iframe loses focus
        const mapIframe = document.querySelector('.map-container iframe');
        if (mapIframe) {
            // When clicking anywhere except inputs, ensure the map can still receive keyboard events
            document.addEventListener('click', function(e) {
                const clickedElement = e.target;
                const isInput = clickedElement.tagName === 'INPUT' || 
                               clickedElement.tagName === 'TEXTAREA' || 
                               clickedElement.isContentEditable;
                
                if (!isInput) {
                    // Remove focus from any focused element
                    if (document.activeElement) {
                        document.activeElement.blur();
                    }
                }
            });
        }

        // Handle button clicks
        document.querySelectorAll('.controls button').forEach(button => {
            button.addEventListener('click', function() {
                const direction = this.textContent.toLowerCase();
                if (canMove) {
                    move(direction);
                }
            });
        });

        // Handle WASD movement
        function move(direction) {
            if (!canMove) return;
            
            fetch('/move', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ direction: direction })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Move error:', data.error);
                    return;
                }

                // Check for game over
                if (data.game_over) {
                    const deathModal = document.getElementById('death-modal');
                    document.getElementById('death-message').textContent = data.message;
                    deathModal.style.display = 'flex';
                    canMove = false;
                    document.querySelector('.controls').classList.add('disabled');
                    return;
                }
                
                // Update position and pan map
                const position = data.position;
                
                // Update map position immediately
                const iframe = document.querySelector('iframe');
                if (iframe) {
                    iframe.contentWindow.postMessage({
                        type: 'updatePosition',
                        lat: position[0],
                        lon: position[1]
                    }, '*');
                }
                
                // Update distance and moves counter
                document.getElementById('distance').textContent = 
                    `${Math.round(data.distance * 100) / 100} km`;
                document.getElementById('moves').textContent = data.moves;
                
                // Update stamina
                updateStaminaBar(data.stamina);
                
                // Update status and handle city entry
                if (data.in_city) {
                    document.getElementById('status').textContent = `In ${data.nearest_city}`;
                    handleCityEntry(data);
                } else {
                    document.getElementById('status').textContent = 'Exploring...';
                }
                
                // Handle random events
                if (data.event) {
                    showEventModal(data.event);
                }
                
                // Check for mysterious location and chateau
                handleMysteriousLocation(data);

                // Update both cities count displays
                document.getElementById('main-cities-count').textContent = `${data.cities_visited}/${data.total_cities}`;
                document.getElementById('cities-visited').textContent = `${data.cities_visited}/${data.total_cities}`;
                
                // Update both location displays
                const locationText = data.current_city || "Exploring";
                document.getElementById('main-current-location').textContent = locationText;
                document.getElementById('current-location').textContent = locationText;
                
                // Update other stats
                document.getElementById('moves-counter').textContent = data.moves;
                document.getElementById('score-counter').textContent = data.score;
            })
            .catch(error => console.error('Error:', error));
        }

        // Handle city entry
        function handleCityEntry(data) {
            if (!data.current_riddle) return;  // Don't show modal if no riddle
            
            const modal = document.getElementById('riddleSection');
            const overlay = document.getElementById('modalOverlay');
            const input = document.getElementById('riddleAnswer');
            
            document.getElementById('cityName').textContent = data.nearest_city;
            document.getElementById('riddleText').textContent = data.current_riddle;
            
            // Show both the overlay and the modal
            overlay.style.display = 'block';
            modal.style.display = 'block';
            
            // Disable movement
            canMove = false;
            document.querySelector('.controls').classList.add('disabled');
            
            // Clear and focus the input
            input.value = '';
            input.focus();
        }

        // Update stamina bar with transition
        function updateStaminaBar(stamina) {
            const staminaFill = document.getElementById('stamina-fill');
            if (staminaFill) {
                staminaFill.style.width = stamina + '%';
                staminaFill.style.backgroundColor = 
                    stamina > 60 ? '#4CAF50' :
                    stamina > 30 ? '#FFC107' :
                    '#F44336';
            }
        }

        // Show event modal
        function showEventModal(event) {
            const eventModal = document.getElementById('event-modal');
            document.getElementById('event-modal-title').textContent = event.title;
            document.getElementById('event-modal-description').textContent = event.description;
            
            const choicesDiv = document.getElementById('event-modal-choices');
            choicesDiv.innerHTML = '';
            event.choices.forEach(choice => {
                const button = document.createElement('button');
                button.textContent = choice.text;
                button.onclick = () => handleEventChoice(choice.text);
                choicesDiv.appendChild(button);
            });
            
            eventModal.style.display = 'flex';
            canMove = false;
            document.querySelector('.controls').classList.add('disabled');
        }

        // Handle event choices
        function handleEventChoice(choice) {
            fetch('/handle_event', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ choice: choice })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update game state
                    document.getElementById('moves').textContent = data.moves;
                    updateStaminaBar(data.stamina);
                    
                    // Update stats box
                    document.getElementById('cities-visited').textContent = `${data.cities_visited}/${data.total_cities}`;
                    document.getElementById('current-location').textContent = data.current_city || "Exploring";
                    document.getElementById('moves-counter').textContent = data.moves;
                    document.getElementById('score-counter').textContent = data.score;
                    
                    // Update companions list
                    const companionsList = document.getElementById('companions-list');
                    if (data.companions && data.companions.length > 0) {
                        companionsList.innerHTML = data.companions
                            .map(companion => `<div class="companion">${companion}</div>`)
                            .join('');
                    } else {
                        companionsList.innerHTML = '<p>No companions yet</p>';
                    }
                    
                    // Hide event modal and re-enable movement
                    const eventModal = document.getElementById('event-modal');
                    eventModal.style.display = 'none';
                    canMove = true;
                    document.querySelector('.controls').classList.remove('disabled');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Also hide modal and re-enable movement on error
                document.getElementById('event-modal').style.display = 'none';
                canMove = true;
                document.querySelector('.controls').classList.remove('disabled');
            });
        }

        // Handle mysterious location and chateau
        function handleMysteriousLocation(data) {
            const iframe = document.querySelector('iframe');
            if (!iframe) return;

            // Handle mysterious location reveal
            if (data.mysterious_location_revealed && data.mysterious_location) {
                iframe.contentWindow.postMessage({
                    type: 'revealMysteriousLocation',
                    location: data.mysterious_location
                }, '*');
            }
            
            // Handle chateau reveal
            if (data.chateau_revealed && data.chateau_location) {
                iframe.contentWindow.postMessage({
                    type: 'revealChateau',
                    location: data.chateau_location
                }, '*');
                
                // Show the chateau reveal modal
                document.getElementById('chateau-reveal').style.display = 'flex';
            }

            // Handle arrival at the chateau
            if (data.at_chateau) {
                // Show the chateau arrival modal with the image and links
                document.getElementById('chateau-arrival').style.display = 'flex';
                
                // Update the chateau content
                const chateauContent = document.querySelector('#chateau-arrival .chateau-content');
                chateauContent.innerHTML = `
                    <h2>The Château Awaits!</h2>
                    <p class="chateau-message">
                        VICTORY! The Château has been revealed! Your journey, sacrifices and commitment all through your life has led you to this one specific moment.
                        Make your way to the château to suckle on its sweet summer fruit...
                    </p>
                    <div class="chateau-links">
                        <p>Learn more about the Château de Goudourville:</p>
                        <a href="https://www.chateaudegoudourville.com" target="_blank" class="btn btn-primary">Official Website</a>
                        <a href="https://www.google.com/maps/place/Ch%C3%A2teau+de+Goudourville" target="_blank" class="btn btn-primary">View on Google Maps</a>
                    </div>
                    <img src="/static/chateau_mist.jpg" alt="Château in the mist" class="chateau-image" style="max-width: 100%; margin-top: 20px;">
                    <button onclick="document.getElementById('chateau-arrival').style.display='none'" class="btn btn-primary">Continue Your Quest</button>
                `;
            }
        }

        // Helper function to calculate distance
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Update the solve_riddle function to handle the modal properly
        function handleRiddleSubmit(event) {
            if (event) event.preventDefault();
            const answer = document.getElementById('riddleAnswer').value.trim().toLowerCase();
            
            if (!answer) {
                showMessage('Please enter an answer', 'error');
                return;
            }
            
            fetch('/solve_riddle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ answer: answer })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update cities visited count
                    document.getElementById('main-cities-count').textContent = `${data.cities_visited}/${data.total_cities}`;
                    document.getElementById('cities-visited').textContent = `${data.cities_visited}/${data.total_cities}`;
                    
                    // Check if all cities are visited and switch to mystery music
                    if (data.cities_visited >= 5) {
                        switchToMysteryMusic();
                    }
                    
                    // Close the modal
                    closeRiddleModal();
                    
                    // Show success message
                    showMessage(data.message, 'success');
                    
                    // Update companions list if provided
                    if (data.companions) {
                        updateCompanions(data.companions);
                    }
                    
                    // Check for mysterious location reveal
                    if (data.mysterious_location_revealed && data.mysterious_location) {
                        const iframe = document.querySelector('iframe');
                        if (iframe) {
                            iframe.contentWindow.postMessage({
                                type: 'revealMysteriousLocation',
                                location: data.mysterious_location
                            }, '*');
                        }
                    }
                } else {
                    showMessage(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('An error occurred while submitting your answer', 'error');
            });
        }

        // Update the event listeners for riddle handling
        document.getElementById('riddleAnswer').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent form submission
                handleRiddleSubmit();
            }
        });

        document.querySelector('.riddle-section button').addEventListener('click', function(e) {
            e.preventDefault();
            handleRiddleSubmit();
        });

        // Close modal when clicking outside
        document.getElementById('modalOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeRiddleModal();
            }
        });

        function closeRiddleModal() {
            const modal = document.getElementById('riddleSection');
            const overlay = document.getElementById('modalOverlay');
            const input = document.getElementById('riddleAnswer');
            
            // Clear the input
            input.value = '';
            
            // Hide both the modal and overlay
            modal.style.display = 'none';
            overlay.style.display = 'none';
            
            // Re-enable movement
            canMove = true;
            document.querySelector('.controls').classList.remove('disabled');
        }

        function submitRiddleAnswer() {
            handleRiddleSubmit();
        }

        // Add message display function if not already present
        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flash-message ${type}`;
            messageDiv.textContent = message;
            
            // Insert at the top of game-info
            const gameInfo = document.querySelector('.game-info');
            gameInfo.insertBefore(messageDiv, gameInfo.firstChild);
            
            // Remove after 5 seconds
            setTimeout(() => messageDiv.remove(), 5000);
        }

        // Add follower update function if not already present
        function updateCompanions(companions) {
            const companionsList = document.getElementById('companions-list');
            if (companions && companions.length > 0) {
                companionsList.innerHTML = companions
                    .map(companion => `<div class="companion">${companion}</div>`)
                    .join('');
                
                // Update the map with companion markers
                const iframe = document.querySelector('iframe');
                if (iframe) {
                    iframe.contentWindow.postMessage({
                        type: 'updateCompanions',
                        companions: companions
                    }, '*');
                }
            } else {
                companionsList.innerHTML = '<p>No companions yet</p>';
            }
        }

        // Update music control functionality
        const bgMusic = document.getElementById('bgMusic');
        const mysteryMusic = document.getElementById('mysteryMusic');
        const volumeControl = document.getElementById('volumeControl');
        const volumeDisplay = document.getElementById('volumeDisplay');

        // Initialize music settings
        bgMusic.volume = 0.5;  // Set initial volume to 50%
        mysteryMusic.volume = 0.5;  // Set initial volume to 50%

        // Start background music immediately
        bgMusic.play().catch(e => {
            // If autoplay is blocked, start on first interaction
            document.addEventListener('click', function startMusic() {
                bgMusic.play();
                document.removeEventListener('click', startMusic);
            }, { once: true });
        });

        // Handle volume changes for both audio elements
        volumeControl.addEventListener('input', (e) => {
            const volume = e.target.value / 100;
            bgMusic.volume = volume;
            mysteryMusic.volume = volume;
            volumeDisplay.textContent = `${e.target.value}%`;
        });

        // Function to switch to mystery music
        function switchToMysteryMusic() {
            const currentVolume = bgMusic.volume;
            const fadeInterval = setInterval(() => {
                if (bgMusic.volume > 0.1) {
                    bgMusic.volume -= 0.1;
                } else {
                    bgMusic.pause();
                    mysteryMusic.volume = 0;
                    mysteryMusic.play();
                    let mysteryVolume = 0;
                    const fadeInInterval = setInterval(() => {
                        if (mysteryVolume < currentVolume) {
                            mysteryVolume += 0.1;
                            mysteryMusic.volume = mysteryVolume;
                        } else {
                            clearInterval(fadeInInterval);
                        }
                    }, 100);
                    clearInterval(fadeInterval);
                }
            }, 100);
        }

        function handleMoveResponse(response) {
            if (response.error) {
                showMessage(response.error, "error");
                return;
            }

            // Update player position on the map
            if (response.position) {
                updatePlayerPosition(response.position);
            }

            // Check for game completion
            if (response.game_completed && response.redirect) {
                // Show completion message
                showMessage("Congratulations! You have completed your quest!", "success");
                // Redirect to leaderboard after a short delay
                setTimeout(() => {
                    window.location.href = response.redirect;
                }, 2000);
                return;
            }

            // Update nearest city and distance
            if (response.nearest_city) {
                updateNearestCity(response.nearest_city, response.distance);
            }

            // Update stamina
            if (response.stamina !== undefined) {
                updateStamina(response.stamina);
            }

            // Update score
            if (response.score) {
                updateScore(response.score);
            }

            // Update companions
            if (response.companions) {
                updateCompanions(response.companions);
            }

            // Handle château reveal
            if (response.chateau_revealed) {
                showChateauReveal();
            }

            // Update game state
            if (response.game_state) {
                updateGameState(response.game_state);
            }
        }

        function updateGameState(gameState) {
            // Update moves counter
            if (gameState.moves !== undefined) {
                document.getElementById("moves-counter").textContent = gameState.moves;
            }
            
            // Update score
            if (gameState.score !== undefined) {
                document.getElementById("score-counter").textContent = gameState.score;
            }
            
            // Update riddles solved
            if (gameState.riddles_solved !== undefined) {
                document.getElementById("riddles-counter").textContent = gameState.riddles_solved;
            }
        }
    </script>
</body>
</html>
